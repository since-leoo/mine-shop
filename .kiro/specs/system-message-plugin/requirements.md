# 需求文档

## 简介

系统消息插件是为 MineAdmin 平台提供的综合通知和消息系统。它提供实时系统通知、用户消息传递和管理通信功能，支持多种消息类型、传递渠道和用户偏好设置。

## 术语表

- **系统消息插件（System_Message_Plugin）**: 处理通知和消息的完整插件系统
- **消息管理器（Message_Manager）**: 负责消息创建、传递和管理的核心服务
- **通知中心（Notification_Center）**: 显示消息和通知的用户界面组件
- **消息队列（Message_Queue）**: 使用 Hyperf async-queue 的异步消息处理系统
- **传递渠道（Delivery_Channel）**: 消息传递方式（站内信、邮件、短信、WebSocket）
- **消息模板（Message_Template）**: 带有动态内容变量的预定义消息格式
- **用户偏好（User_Preference）**: 用户对消息类型和传递方式的个人设置
- **管理面板（Admin_Panel）**: 管理系统消息和模板的管理界面
- **小程序推送（MiniApp_Push）**: 微信小程序、支付宝小程序等移动端推送服务（下期功能）
- **推送适配器（Push_Adapter）**: 统一不同推送服务的接口适配层（下期功能）

## 需求

### 需求 1：插件基础架构

**用户故事：** 作为系统管理员，我希望能够安装和管理系统消息插件，以便在平台上启用消息传递功能。

#### 验收标准

1. 当插件安装时，系统消息插件应创建所有必要的数据库表和配置
2. 当插件激活时，系统消息插件应注册所有必需的服务和路由
3. 当插件停用时，系统消息插件应优雅地禁用所有消息功能而不丢失数据
4. 当插件卸载时，系统消息插件应提供保留或删除消息数据的选项
5. 系统消息插件应与现有的 MineAdmin 权限系统集成

### 需求 2：消息创建和管理

**用户故事：** 作为管理员，我希望创建和管理系统消息，以便向用户传达重要信息。

#### 验收标准

1. 当创建消息时，消息管理器应验证所有必需字段（标题、内容、收件人）
2. 当创建消息时，消息管理器应支持多种收件人类型（所有用户、特定角色、个人用户）
3. 当安排消息时，消息管理器应允许未来的传递日期和时间
4. 当编辑消息时，消息管理器应保留消息历史记录并跟踪更改
5. 消息管理器应支持带有变量替换的消息模板
6. 消息管理器应按类型对消息进行分类（系统、公告、警报、提醒）

### 需求 3：实时消息传递

**用户故事：** 作为用户，我希望实时接收消息，以便及时了解重要的系统更新和通信。

#### 验收标准

1. 当发送消息时，传递渠道应通过 WebSocket 传递实时通知
2. 当用户离线时，消息队列应存储消息以便在用户返回时传递
3. 当传递消息时，系统消息插件应尊重用户通知偏好
4. 当消息传递失败时，消息队列应根据配置的重试策略进行重试
5. 系统消息插件应支持多种传递渠道（站内信、邮件、短信）
6. 系统消息插件应为未来版本预留小程序推送接口（微信小程序、支付宝小程序等）

### 需求 4：用户界面和体验

**用户故事：** 作为用户，我希望有一个直观的界面来查看和管理我的消息，以便高效处理通信。

#### 验收标准

1. 当访问消息时，通知中心应显示带有过滤选项的有序列表
2. 当查看消息时，通知中心应显示消息状态（已读/未读、优先级）
3. 当与消息交互时，通知中心应支持操作（标记为已读、删除、归档）
4. 当接收新消息时，通知中心应显示带有声音/视觉警报的实时通知
5. 通知中心应提供跨消息内容和元数据的搜索功能
6. 通知中心应支持大量消息的分页

### 需求 5：消息模板和自动化

**用户故事：** 作为管理员，我希望创建可重用的消息模板，以便高效发送一致的通信。

#### 验收标准

1. 当创建模板时，消息模板应支持动态内容的变量占位符
2. 当使用模板时，消息管理器应正确验证和替换所有变量
3. 当管理模板时，管理面板应提供模板管理的 CRUD 操作
4. 消息模板应支持不同格式（纯文本、HTML、markdown）
5. 消息模板应包含发送前的预览功能

### 需求 6：用户偏好和设置

**用户故事：** 作为用户，我希望自定义我的通知偏好，以便控制如何以及何时接收消息。

#### 验收标准

1. 当配置偏好时，用户偏好应允许为每种消息类型选择传递渠道
2. 当设置偏好时，用户偏好应支持免打扰时间段
3. 当管理偏好时，用户偏好应提供对消息类别的精细控制
4. 用户偏好应在用户会话和设备间持久化
5. 用户偏好应包含新用户的默认设置

### 需求 7：管理仪表板

**用户故事：** 作为管理员，我希望有一个综合仪表板来监控和管理消息系统，以便确保有效的通信。

#### 验收标准

1. 当查看仪表板时，管理面板应显示消息传递统计和指标
2. 当监控消息时，管理面板应显示传递状态和失败报告
3. 当管理用户时，管理面板应提供批量消息功能
4. 管理面板应支持消息调度和活动管理
5. 管理面板应提供所有消息活动的审计日志

### 需求 8：集成和 API

**用户故事：** 作为开发者，我希望能够程序化访问消息系统，以便将消息集成到其他系统组件中。

#### 验收标准

1. 当使用 API 时，系统消息插件应为所有消息操作提供 RESTful 端点
2. 当与其他模块集成时，系统消息插件应支持事件驱动的消息触发器
3. 当访问 API 时，系统消息插件应强制执行适当的身份验证和授权
4. 系统消息插件应提供外部系统集成的 webhook 支持
5. 系统消息插件应包含全面的 API 文档

### 需求 9：性能和可扩展性

**用户故事：** 作为系统管理员，我希望消息系统能够高效处理大量消息，以便不影响整体系统性能。

#### 验收标准

1. 当处理消息时，消息队列应处理大量消息而不阻塞主应用程序
2. 当存储消息时，系统消息插件应实现高效的数据库索引和归档
3. 当传递消息时，系统消息插件应支持批量操作的批处理
4. 系统消息插件应为频繁访问的数据实现缓存
5. 系统消息插件应提供性能调优的配置选项

### 需求 10：安全和隐私

**用户故事：** 作为安全管理员，我希望消息系统保护敏感信息，以便维护用户隐私和系统安全。

#### 验收标准

1. 当处理消息时，系统消息插件应加密敏感消息内容
2. 当访问消息时，系统消息插件应强制执行基于角色的访问控制
3. 当记录活动时，系统消息插件应从日志中排除敏感信息
4. 系统消息插件应支持消息保留策略和自动清理
5. 系统消息插件应验证和清理所有用户输入以防止安全漏洞
### 需求 11：未来扩展规划（下期功能）

**用户故事：** 作为产品经理，我希望为小程序消息推送预留扩展接口，以便在下期版本中支持移动端推送功能。

#### 验收标准

1. 当设计传递渠道时，系统消息插件应预留小程序推送的接口扩展点
2. 当设计消息模板时，消息模板应考虑小程序消息格式的兼容性
3. 当设计用户偏好时，用户偏好应预留小程序推送设置的数据结构
4. 系统消息插件应设计推送适配器模式以便未来集成不同的推送服务
5. 系统消息插件应在数据库设计中预留小程序用户标识和推送令牌字段

#### 小程序推送功能规划（下期实现）

1. **微信小程序推送**
   - 支持微信小程序模板消息
   - 支持微信小程序订阅消息
   - 集成微信小程序 API

2. **支付宝小程序推送**
   - 支持支付宝小程序模板消息
   - 集成支付宝小程序 API

3. **其他小程序平台**
   - 预留百度小程序、字节跳动小程序等平台接口
   - 统一的推送适配器设计

4. **移动端推送增强**
   - 推送到达率统计
   - 推送效果分析
   - 个性化推送策略