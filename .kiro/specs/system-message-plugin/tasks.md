# 实施计划：系统消息插件

## 概述

本实施计划将系统消息插件的设计转换为一系列增量开发任务。每个任务都建立在前面的任务基础上，最终将所有组件整合在一起。重点关注编写、修改或测试代码的任务。

## 任务

- [x] 1. 创建插件基础结构和配置
  - 创建插件目录结构
  - 编写 mine.json 配置文件
  - 实现 ConfigProvider.php 配置提供者
  - 创建 InstallScript.php 和 UninstallScript.php
  - _需求：1.1, 1.2, 1.4_

- [ ]* 1.1 编写插件基础结构的单元测试
  - 测试配置提供者的服务注册
  - 测试安装和卸载脚本的功能
  - _需求：1.1, 1.2, 1.4_

- [x] 2. 实现数据库迁移和模型
  - [x] 2.1 创建数据库迁移文件
    - 创建 system_messages 表迁移
    - 创建 user_messages 表迁移
    - 创建 message_templates 表迁移
    - 创建 user_notification_preferences 表迁移
    - 创建 message_delivery_logs 表迁移
    - _需求：2.1, 2.2, 5.1, 6.1, 7.2_

  - [x] 2.2 实现数据模型类
    - 创建 Message 模型及其关联关系
    - 创建 UserMessage 模型
    - 创建 MessageTemplate 模型
    - 创建 UserNotificationPreference 模型
    - 创建 MessageDeliveryLog 模型
    - _需求：2.1, 2.6, 5.1, 6.1_

- [ ]* 2.3 编写模型的属性测试
  - **属性 4：消息历史记录**
  - **验证需求：需求 2.4**

- [ ]* 2.4 编写模型的单元测试
  - 测试模型关联关系
  - 测试模型验证规则
  - _需求：2.1, 2.6, 5.1, 6.1_

- [x] 3. 实现核心服务层
  - [x] 3.1 实现 MessageService 服务
    - 实现消息创建、更新、删除功能
    - 实现消息发送和调度功能
    - 实现收件人解析逻辑
    - _需求：2.1, 2.2, 2.3, 2.6_

  - [x] 3.2 实现 TemplateService 服务
    - 实现模板创建和管理功能
    - 实现模板变量替换和渲染功能
    - 实现模板预览功能
    - _需求：5.1, 5.2, 5.4, 5.5_

  - [x] 3.3 实现 NotificationService 服务
    - 实现多渠道通知发送功能
    - 实现用户偏好检查逻辑
    - 实现免打扰时间处理
    - _需求：3.1, 3.3, 6.2_

- [ ]* 3.4 编写服务层的属性测试
  - **属性 1：消息创建验证**
  - **验证需求：需求 2.1**
  - **属性 2：收件人类型处理**
  - **验证需求：需求 2.2**
  - **属性 5：模板变量替换往返**
  - **验证需求：需求 2.5**

- [ ]* 3.5 编写服务层的单元测试
  - 测试消息服务的核心功能
  - 测试模板服务的渲染功能
  - 测试通知服务的发送逻辑
  - _需求：2.1, 2.2, 5.1, 5.2, 3.1, 3.3_

- [ ] 4. 检查点 - 确保核心服务测试通过
  - 确保所有测试通过，如有问题请询问用户。

- [x] 5. 实现仓库层
  - [x] 5.1 实现 MessageRepository 仓库
    - 实现消息查询和过滤功能
    - 实现分页和排序功能
    - 实现消息统计功能
    - _需求：4.1, 4.5, 4.6, 7.1_

  - [x] 5.2 实现 TemplateRepository 仓库
    - 实现模板查询和管理功能
    - 实现模板分类和搜索功能
    - _需求：5.3, 5.4_

  - [x] 5.3 实现 UserPreferenceRepository 仓库
    - 实现用户偏好查询和更新功能
    - 实现默认偏好设置功能
    - _需求：6.1, 6.3, 6.4, 6.5_

- [ ]* 5.4 编写仓库层的属性测试
  - **属性 11：消息列表过滤**
  - **验证需求：需求 4.1**
  - **属性 15：搜索功能**
  - **验证需求：需求 4.5**
  - **属性 16：分页功能**
  - **验证需求：需求 4.6**

- [x] 6. 实现消息队列和异步处理
  - [x] 6.1 实现消息队列处理器
    - 创建消息发送队列任务
    - 实现批量消息处理
    - 实现重试机制
    - _需求：3.2, 3.4, 9.3_

  - [x] 6.2 实现事件监听器
    - 创建消息状态变更监听器
    - 创建用户操作事件监听器
    - 实现审计日志记录
    - _需求：7.5, 8.2_

- [ ]* 6.3 编写队列和事件的属性测试
  - **属性 8：离线消息存储**
  - **验证需求：需求 3.2**
  - **属性 10：重试机制**
  - **验证需求：需求 3.4**
  - **属性 31：事件驱动消息**
  - **验证需求：需求 8.2**

- [x] 7. 实现 WebSocket 实时通知
  - [x] 7.1 创建 WebSocket 服务
    - 实现 WebSocket 连接管理
    - 实现实时消息推送
    - 实现用户在线状态跟踪
    - _需求：3.1, 4.4_

  - [x] 7.2 集成 WebSocket 与消息服务
    - 在消息发送时触发实时通知
    - 实现消息状态实时更新
    - _需求：3.1, 4.4_

- [ ]* 7.3 编写 WebSocket 的属性测试
  - **属性 7：实时通知传递**
  - **验证需求：需求 3.1**
  - **属性 14：实时通知显示**
  - **验证需求：需求 4.4**

- [x] 8. 实现后端 API 控制器
  - [x] 8.1 实现 MessageController 管理端控制器
    - 实现消息 CRUD API 端点
    - 实现消息发送和调度 API
    - 实现批量操作 API
    - _需求：2.1, 2.2, 2.3, 7.3_

  - [x] 8.2 实现 UserMessageController 用户端控制器
    - 实现用户消息列表 API
    - 实现消息状态更新 API
    - 实现消息操作 API
    - _需求：4.1, 4.2, 4.3, 4.5, 4.6_

  - [x] 8.3 实现 TemplateController 模板控制器
    - 实现模板管理 API
    - 实现模板预览 API
    - _需求：5.1, 5.2, 5.3, 5.5_

  - [x] 8.4 实现 PreferenceController 偏好控制器
    - 实现用户偏好设置 API
    - 实现偏好查询和更新 API
    - _需求：6.1, 6.2, 6.3_

- [ ]* 8.5 编写控制器的属性测试
  - **属性 19：模板 CRUD 操作**
  - **验证需求：需求 5.3**
  - **属性 32：API 身份验证**
  - **验证需求：需求 8.3**
  - **属性 36：访问控制**
  - **验证需求：需求 10.2**

- [ ]* 8.6 编写控制器的单元测试
  - 测试 API 端点的请求和响应
  - 测试权限验证和错误处理
  - _需求：8.1, 8.3, 10.2_

- [x] 9. 实现请求验证和中间件
  - [x] 9.1 创建请求验证类
    - 创建消息创建和更新验证
    - 创建模板验证
    - 创建用户偏好验证
    - _需求：2.1, 5.1, 6.1, 10.5_

  - [x] 9.2 实现安全中间件
    - 创建消息权限验证中间件
    - 实现输入清理和验证中间件
    - _需求：10.2, 10.5_

- [ ]* 9.3 编写验证和中间件的属性测试
  - **属性 39：输入验证**
  - **验证需求：需求 10.5**

- [ ] 10. 检查点 - 确保后端 API 测试通过
  - 确保所有测试通过，如有问题请询问用户。

- [x] 11. 实现前端基础结构
  - [x] 11.1 创建前端插件配置
    - 创建插件入口文件 index.ts
    - 配置路由和菜单
    - 设置插件基本信息
    - _需求：4.1, 4.2_

  - [x] 11.2 实现 API 接口层
    - 创建消息 API 接口
    - 创建模板 API 接口
    - 创建用户偏好 API 接口
    - _需求：8.1, 8.2, 8.3, 8.4_

  - [x] 11.3 实现状态管理
    - 创建消息状态管理
    - 创建用户偏好状态管理
    - 创建通知状态管理
    - _需求：4.1, 4.2, 6.1_

- [x] 12. 实现用户端消息中心界面
  - [x] 12.1 创建消息列表组件
    - 实现消息列表显示
    - 实现消息过滤和搜索
    - 实现分页功能
    - _需求：4.1, 4.5, 4.6_

  - [x] 12.2 创建消息详情组件
    - 实现消息内容显示
    - 实现消息状态管理
    - 实现消息操作功能
    - _需求：4.2, 4.3_

  - [x] 12.3 创建消息通知组件
    - 实现通知图标和徽章
    - 实现实时通知显示
    - 集成 WebSocket 连接
    - _需求：4.4, 3.1_

- [ ]* 12.4 编写前端组件的单元测试
  - 测试组件渲染和交互
  - 测试状态管理和 API 调用
  - _需求：4.1, 4.2, 4.3, 4.4_

- [x] 13. 实现用户偏好设置界面
  - [x] 13.1 创建偏好设置组件
    - 实现通知渠道选择
    - 实现消息类型偏好设置
    - 实现免打扰时间设置
    - _需求：6.1, 6.2, 6.3_

  - [x] 13.2 集成偏好设置与消息中心
    - 实现偏好设置的实时生效
    - 实现默认偏好的初始化
    - _需求：6.4, 6.5_

- [ ]* 13.3 编写偏好设置的属性测试
  - **属性 22：偏好配置**
  - **验证需求：需求 6.1**
  - **属性 23：免打扰功能**
  - **验证需求：需求 6.2**
  - **属性 25：偏好持久化**
  - **验证需求：需求 6.4**

- [x] 14. 实现管理端界面
  - [x] 14.1 创建消息管理界面
    - 实现消息创建和编辑表单
    - 实现消息列表和状态管理
    - 实现批量操作功能
    - _需求：2.1, 2.2, 2.3, 7.3_

  - [x] 14.2 创建模板管理界面
    - 实现模板创建和编辑
    - 实现模板预览功能
    - 实现模板变量管理
    - _需求：5.1, 5.2, 5.3, 5.5_

  - [x] 14.3 创建管理仪表板
    - 实现消息统计图表
    - 实现传递状态监控
    - 实现审计日志查看
    - _需求：7.1, 7.2, 7.5_

- [ ]* 14.4 编写管理界面的单元测试
  - 测试表单验证和提交
  - 测试数据展示和交互
  - _需求：2.1, 5.1, 7.1_

- [ ] 15. 实现安全和权限控制
  - [ ] 15.1 集成权限系统
    - 实现基于角色的访问控制
    - 集成 MineAdmin 权限系统
    - _需求：1.5, 10.2_

  - [ ] 15.2 实现数据安全
    - 实现敏感内容加密
    - 实现日志安全处理
    - 实现数据保留策略
    - _需求：10.1, 10.3, 10.4_

- [ ]* 15.3 编写安全功能的属性测试
  - **属性 35：敏感内容加密**
  - **验证需求：需求 10.1**
  - **属性 37：日志安全**
  - **验证需求：需求 10.3**
  - **属性 38：数据保留策略**
  - **验证需求：需求 10.4**

- [ ] 16. 实现扩展接口预留
  - [ ] 16.1 设计推送适配器接口
    - 创建推送服务抽象接口
    - 实现现有渠道的适配器
    - 预留小程序推送接口
    - _需求：11.1, 11.4_

  - [ ] 16.2 实现 Webhook 支持
    - 创建 Webhook 配置管理
    - 实现 Webhook 调用功能
    - _需求：8.4_

- [ ]* 16.3 编写扩展接口的属性测试
  - **属性 33：Webhook 支持**
  - **验证需求：需求 8.4**

- [ ] 17. 集成测试和系统测试
  - [ ] 17.1 实现端到端测试
    - 测试完整的消息发送流程
    - 测试用户交互流程
    - 测试管理功能流程
    - _需求：所有核心需求_

  - [ ] 17.2 实现性能测试
    - 测试大量消息处理性能
    - 测试并发用户访问性能
    - _需求：9.1, 9.3_

- [ ]* 17.3 编写系统级属性测试
  - **属性 34：批处理功能**
  - **验证需求：需求 9.3**
  - **属性 30：审计日志**
  - **验证需求：需求 7.5**

- [ ] 18. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 19. 文档和部署准备
  - [ ] 19.1 编写插件文档
    - 创建 README.md 说明文档
    - 编写 API 文档
    - 创建用户使用指南
    - _需求：8.5_

  - [ ] 19.2 准备发布配置
    - 配置生产环境设置
    - 创建部署脚本
    - 验证插件完整性
    - _需求：1.1, 1.2_

## 注意事项

- 标记为 `*` 的任务是可选的，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求以确保可追溯性
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边界情况
- 所有测试必须在任务完成前通过